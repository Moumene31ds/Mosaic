<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mosaic Pro V4 - iPhone Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000000;
            --panel: rgba(28, 28, 30, 0.95);
            --accent: #0A84FF; /* iOS Blue */
            --danger: #FF453A;
            --text: #ffffff;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Tajawal', sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            z-index: 10;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 500; letter-spacing: 0.5px; }
        .btn-text { background: none; border: none; color: var(--accent); font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-text.cancel { color: var(--danger); }

        /* --- Canvas Area --- */
        #workspace {
            flex-grow: 1;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        canvas {
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-width: 100%; max-height: 100%;
            transition: transform 0.2s;
        }

        /* --- The Magnifier (المكبر) --- */
        .magnifier {
            position: absolute;
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            overflow: hidden;
            pointer-events: none;
            display: none;
            z-index: 100;
            background: #fff;
        }
        .magnifier canvas {
            position: absolute;
            top: 0; left: 0;
            /* سيتم تحريك هذا بالكود */
        }
        .magnifier::after {
            content: '+';
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.5); font-size: 20px;
        }

        /* --- Bottom Controls (iOS Style) --- */
        .controls {
            background: var(--panel);
            backdrop-filter: blur(20px);
            padding: 20px 15px 40px 15px; /* Extra padding for iPhone bottom bar */
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex; flex-direction: column; gap: 20px;
            z-index: 20;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* Tools Selector */
        .tools-scroll {
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px;
            justify-content: center;
        }
        .tool-btn {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            background: none; border: none; color: #888;
            min-width: 60px; cursor: pointer; transition: 0.2s;
        }
        .tool-btn .icon-box {
            width: 50px; height: 50px;
            background: #2C2C2E;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .tool-btn span { font-size: 24px; }
        .tool-btn p { margin: 0; font-size: 11px; font-family: 'Tajawal'; }
        
        .tool-btn.active .icon-box { background: var(--accent); color: white; transform: translateY(-5px); box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4); }
        .tool-btn.active p { color: white; }

        /* Sliders */
        .slider-container { display: flex; align-items: center; gap: 15px; padding: 0 10px; }
        .slider-label { width: 30px; color: #888; text-align: center; font-size: 12px; }
        
        input[type="range"] {
            flex-grow: 1; -webkit-appearance: none; background: #3A3A3C; height: 4px; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* Loader */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200;
            display: none; justify-content: center; align-items: center; flex-direction: column; color: white;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        input[type="file"] { display: none; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

    <header>
        <button class="btn-text cancel" onclick="resetCanvas()">مسح الكل</button>
        <h1>Mosaic Pro</h1>
        <label for="file-upload" class="btn-text">فتح صورة</label>
        <input type="file" id="file-upload" accept="image/*">
    </header>

    <div id="workspace">
        <div class="magnifier" id="magnifier">
            <canvas id="mag-canvas"></canvas>
        </div>
        <canvas id="main-canvas"></canvas>
    </div>

    <div class="controls">
        <div class="slider-container">
            <span class="material-icons slider-label">brush</span>
            <input type="range" id="brush-size" min="10" max="150" value="40">
            <span class="material-icons slider-label" style="font-size: 20px;">circle</span>
        </div>

        <div class="tools-scroll">
            <button class="tool-btn active" onclick="setTool('mosaic')">
                <div class="icon-box"><span class="material-icons-round">grid_view</span></div>
                <p>مربعات</p>
            </button>
            
            <button class="tool-btn" onclick="setTool('blur')">
                <div class="icon-box"><span class="material-icons-round">blur_on</span></div>
                <p>ضباب</p>
            </button>

            <button class="tool-btn" onclick="setTool('crystal')">
                <div class="icon-box"><span class="material-icons-round">details</span></div>
                <p>كريستال</p>
            </button>

            <button class="tool-btn" onclick="setTool('eraser')">
                <div class="icon-box"><span class="material-icons-round">cleaning_services</span></div>
                <p>ممحاة</p>
            </button>

            <div style="width: 1px; background: #333; margin: 0 5px;"></div>

            <button class="tool-btn" onclick="detectFaces()">
                <div class="icon-box" style="background: linear-gradient(135deg, #FF2D55, #FF375F); color: white;">
                    <span class="material-icons-round">face_retouching_natural</span>
                </div>
                <p>AI تلقائي</p>
            </button>

            <button class="tool-btn" onclick="saveImage()">
                <div class="icon-box" style="background: #30D158; color: white;">
                    <span class="material-icons-round">save_alt</span>
                </div>
                <p>حفظ</p>
            </button>
        </div>
    </div>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p id="loader-text">جاري المعالجة...</p>
    </div>

    <script>
        // --- تهيئة المتغيرات ---
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // متغيرات المكبر
        const magnifier = document.getElementById('magnifier');
        const magCanvas = document.getElementById('mag-canvas');
        const magCtx = magCanvas.getContext('2d');

        let originalImg = new Image();
        let currentTool = 'mosaic';
        let isDrawing = false;
        let brushSize = 40;
        let historyStack = [];

        // --- تحميل الصورة ---
        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                originalImg.onload = () => {
                    // ضبط أبعاد الكانفاس لتناسب الشاشة
                    const workspace = document.getElementById('workspace');
                    const maxWidth = workspace.clientWidth;
                    const maxHeight = workspace.clientHeight;
                    
                    // حساب النسبة للحفاظ على الأبعاد
                    let newWidth = originalImg.width;
                    let newHeight = originalImg.height;
                    
                    if (newWidth > 2000 || newHeight > 2000) { // تصغير الصور العملاقة للأداء
                         const ratio = Math.min(2000 / newWidth, 2000 / newHeight);
                         newWidth *= ratio;
                         newHeight *= ratio;
                    }

                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    // عرض الصورة
                    ctx.drawImage(originalImg, 0, 0, newWidth, newHeight);
                    
                    // حفظ نسخة للأصل (للممحاة)
                    // تحديث originalImg ليشير للنسخة المصغرة في الذاكرة
                    const tempC = document.createElement('canvas');
                    tempC.width = newWidth; tempC.height = newHeight;
                    tempC.getContext('2d').drawImage(originalImg, 0, 0, newWidth, newHeight);
                    originalImg.src = tempC.toDataURL(); // تحديث المصدر ليكون الصورة الحالية

                    saveHistory();
                };
                originalImg.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- أدوات النظام ---
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        document.getElementById('brush-size').addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
        });

        // --- المحرك الرئيسي للتأثيرات (Advanced Effect Engine) ---
        function applyEffect(x, y) {
            const size = brushSize * (canvas.width / 800) * 1.5; // حجم نسبي
            const r = size / 2;

            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.clip(); // العمل داخل الدائرة فقط

            if (currentTool === 'eraser') {
                // الممحاة الذكية: تعيد رسم الصورة الأصلية في هذه المنطقة
                ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);
            } 
            else if (currentTool === 'mosaic') {
                // تأثير الموزايك
                ctx.imageSmoothingEnabled = false;
                const pixelSize = Math.max(5, canvas.width / 80); // حجم تلقائي للمربعات
                
                // الطريقة السريعة: تصغير ثم تكبير المنطقة
                // نستخدم خدعة لرسم كامل الصورة مصغرة ثم مكبرة، لكن الـ CLIP يظهر فقط الدائرة
                const w = canvas.width;
                const h = canvas.height;
                const sw = w / pixelSize;
                const sh = h / pixelSize;
                
                // طبقة مؤقتة
                const tempC = document.createElement('canvas');
                tempC.width = sw; tempC.height = sh;
                const tempCtx = tempC.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0, sw, sh);
                
                // الرسم على الكانفاس الأصلي
                ctx.drawImage(tempC, 0, 0, sw, sh, 0, 0, w, h);
            
            } 
            else if (currentTool === 'blur') {
                // تأثير الضباب
                ctx.filter = 'blur(15px)';
                ctx.drawImage(canvas, 0, 0); // رسم الصورة فوق نفسها مع فلتر
                ctx.filter = 'none';
            }
            else if (currentTool === 'crystal') {
                // تأثير الكريستال (محاكاة Pointillize)
                // هذا يتطلب كود معقد، سنحاكيه بفلتر ضباب + تباين عالي + نويز
                // أو نستخدم فلتر فسيفساء سداسية بسيط (محاكاة)
                ctx.imageSmoothingEnabled = false;
                ctx.filter = 'contrast(150%) blur(2px)';
                
                // رسم طبقة منقطة
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                for(let i=0; i<10; i++) {
                     let rx = x - r + Math.random() * size;
                     let ry = y - r + Math.random() * size;
                     ctx.fillRect(rx, ry, size/5, size/5);
                }
                
                const pSize = Math.max(10, canvas.width / 50);
                const tempC = document.createElement('canvas');
                tempC.width = canvas.width / pSize; tempC.height = canvas.height / pSize;
                tempC.getContext('2d').drawImage(canvas, 0, 0, tempC.width, tempC.height);
                ctx.drawImage(tempC, 0, 0, tempC.width, tempC.height, 0, 0, canvas.width, canvas.height);
                ctx.filter = 'none';
            }

            ctx.restore();
        }

        // --- نظام التفاعل (Touch & Mouse) ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY,
                screenX: clientX,
                screenY: clientY
            };
        }

        function updateMagnifier(pos) {
            if (!isDrawing) { magnifier.style.display = 'none'; return; }
            
            // إظهار المكبر
            magnifier.style.display = 'block';
            // تحريك المكبر ليكون فوق الاصبع قليلاً (مثل الآيفون)
            magnifier.style.left = (pos.screenX - 50) + 'px';
            magnifier.style.top = (pos.screenY - 120) + 'px';

            // رسم محتوى المكبر
            magCanvas.width = 200; // دقة عالية للمكبر
            magCanvas.height = 200;
            
            // نأخذ لقطة من الكانفاس الأصلي حول نقطة اللمس
            const zoomLevel = 2; // قوة التكبير
            const sourceW = 100 / zoomLevel;
            const sourceH = 100 / zoomLevel;
            
            // تنظيف الخلفية
            magCtx.fillStyle = '#fff';
            magCtx.fillRect(0,0,200,200);

            // رسم الجزء المكبر
            // نرسم من الصورة الأصلية (لكي يرى المستخدم ماذا يغطي) أو من الكانفاس (ليرى النتيجة)
            // في تطبيقات التغبيش، عادة نري المستخدم ما هو "تحت" اصبعه (الكانفاس الحالي)
            magCtx.drawImage(canvas, 
                pos.x - (100/zoomLevel), pos.y - (100/zoomLevel), 200/zoomLevel, 200/zoomLevel,
                0, 0, 200, 200
            );
            
            // رسم علامة + في المنتصف
            magCtx.strokeStyle = 'rgba(255,0,0,0.5)';
            magCtx.lineWidth = 1;
            magCtx.beginPath();
            magCtx.moveTo(100, 90); magCtx.lineTo(100, 110);
            magCtx.moveTo(90, 100); magCtx.lineTo(110, 100);
            magCtx.stroke();
        }

        function handleStart(e) {
            e.preventDefault(); // منع السكرول
            isDrawing = true;
            handleMove(e);
        }

        function handleMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            
            applyEffect(pos.x, pos.y);
            updateMagnifier(pos);
        }

        function handleEnd() {
            isDrawing = false;
            magnifier.style.display = 'none';
            saveHistory();
        }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        canvas.addEventListener('touchend', handleEnd);

        // --- الذكاء الاصطناعي (Face API) ---
        async function detectFaces() {
            if(!originalImg.src) return alert('الرجاء اختيار صورة');
            
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            document.getElementById('loader-text').innerText = 'تحميل الذكاء الاصطناعي...';

            try {
                // تحميل الموديل عند الطلب فقط لتسريع التطبيق
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                
                document.getElementById('loader-text').innerText = 'كشف الوجوه...';
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.3 });
                const detections = await faceapi.detectAllFaces(canvas, options);

                if(detections.length === 0) {
                    alert('لم يتم العثور على وجوه!');
                } else {
                    // تطبيق الفلتر الحالي على كل وجه
                    detections.forEach(det => {
                        const { x, y, width, height } = det.box;
                        // محاكاة حركة الفرشاة على المنطقة
                        const cx = x + width/2;
                        const cy = y + height/2;
                        // نكبر المنطقة قليلاً
                        const radius = Math.max(width, height) * 0.6;
                        
                        // تطبيق تأثير دائري كبير
                        brushSize = radius / (canvas.width / 800) / 1.5 * 2; // معادلة عكسية لضبط حجم الفرشاة
                        applyEffect(cx, cy);
                    });
                    saveHistory();
                }

            } catch (err) {
                console.error(err);
                alert('تأكد من وجود مجلد /models');
            }
            loader.style.display = 'none';
        }

        // --- إدارة المحفوظات (History) ---
        function saveHistory() {
            if(historyStack.length > 10) historyStack.shift();
            historyStack.push(canvas.toDataURL());
        }

        function resetCanvas() {
            if(confirm('هل أنت متأكد من مسح جميع التعديلات؟')) {
                ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);
                saveHistory();
            }
        }

        function saveImage() {
            const link = document.createElement('a');
            link.download = 'Mosaic_Pro_iOS.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        }

    </script>
</body>
</html>
