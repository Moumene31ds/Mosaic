<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosaic Pro - Ù…Ø«Ù„ Ø§Ù„Ø¢ÙŠÙÙˆÙ†</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --surface: #1E1E1E;
            --primary: #BB86FC;
            --secondary: #03DAC6;
            --text: #ffffff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: var(--primary); }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Canvas) --- */
        .canvas-wrapper {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            overflow: hidden;
            position: relative;
            background: repeating-conic-gradient(#222 0% 25%, #181818 0% 50%) 50% / 20px 20px;
            border-radius: 10px;
            margin: 10px 0;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
        }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ --- */
        .toolbar {
            background: var(--surface);
            width: 100%;
            max-width: 600px;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
        }

        .tools-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± */
        .filter-group {
            display: flex;
            background: #2C2C2C;
            border-radius: 12px;
            padding: 4px;
            flex-grow: 1;
        }

        .filter-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #aaa;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: #000;
            font-weight: bold;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .action-btn {
            background: #333;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .action-btn:hover { background: #444; }
        .action-btn.ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .action-btn.save { background: var(--secondary); color: #000; }

        /* Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø§Ø© */
        .brush-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        input[type="range"] {
            flex-grow: 1;
            accent-color: var(--primary);
            height: 4px;
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-size: 1.2rem;
            flex-direction: column;
        }
        
        input[type="file"] { display: none; }

    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

    <header>
        <h1>MOSAIC</h1>
        <button class="action-btn save" id="btn-save" title="Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©"><span class="material-icons">save</span></button>
    </header>

    <div class="canvas-wrapper" id="wrapper">
        <div class="loading-overlay" id="loader">
            <span>ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬ÙˆÙ‡...</span>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <div class="toolbar">
        <div class="tools-row">
            <div class="filter-group">
                <button class="filter-btn active" onclick="setFilter('mosaic')">Ù…Ø±Ø¨Ø¹Ø§Øª</button>
                <button class="filter-btn" onclick="setFilter('blur')">Ø¶Ø¨Ø§Ø¨</button>
                <button class="filter-btn" onclick="setFilter('color')">Ù„ÙˆÙ†</button>
            </div>
        </div>

        <div class="tools-row brush-control">
            <span class="material-icons" style="font-size: 14px;">circle</span>
            <input type="range" id="brush-size" min="10" max="100" value="40">
            <span class="material-icons" style="font-size: 24px;">circle</span>
        </div>

        <div class="tools-row" style="justify-content: center; gap: 20px;">
            <label for="upload" class="action-btn" title="ÙØªØ­ ØµÙˆØ±Ø©"><span class="material-icons">add_photo_alternate</span></label>
            <input type="file" id="upload" accept="image/*">

            <button class="action-btn ai" id="btn-auto" title="ÙƒØ´Ù Ø§Ù„ÙˆØ¬ÙˆÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">AI</button>
            
            <button class="action-btn" id="btn-undo" title="ØªØ±Ø§Ø¬Ø¹"><span class="material-icons">undo</span></button>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const loader = document.getElementById('loader');
        const brushSlider = document.getElementById('brush-size');
        
        let originalImage = new Image();
        let historyStack = [];
        let currentFilter = 'mosaic'; // mosaic, blur, color
        let isDrawing = false;

        // --- ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
        async function loadModels() {
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ models ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±
            try {
                // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                console.log("AI Models Loaded");
            } catch (e) {
                console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø¬Ù„Ø¯ /models");
                // ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù‡Ù†Ø§ ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
            }
        }
        loadModels();

        // --- 1. Ø±ÙØ¹ ÙˆØ¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ---
        document.getElementById('upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                originalImage.onload = () => {
                    // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                    const wrapper = document.getElementById('wrapper');
                    
                    // Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù„ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                    canvas.width = originalImage.width;
                    canvas.height = originalImage.height;
                    
                    // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                    ctx.drawImage(originalImage, 0, 0);
                    saveState(); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                };
                originalImage.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- 2. Ù…Ø­Ø±Ùƒ Ø§Ù„ÙÙ„Ø§ØªØ± (The Filter Engine) ---
        function setFilter(type) {
            currentFilter = type;
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ·Ø¨Ù‚ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¯Ø¯Ø© (Ù…Ø±Ø¨Ø¹ Ø£Ùˆ Ø¯Ø§Ø¦Ø±Ø©)
        function applyEffectToRegion(x, y, w, h, isCircle = false) {
            ctx.save();
            ctx.beginPath();
            
            if (isCircle) {
                // Ù„Ù„ÙØ±Ø´Ø§Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø¦Ø±Ø©
                ctx.arc(x, y, w/2, 0, Math.PI * 2);
            } else {
                // Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹
                ctx.rect(x, y, w, h);
            }
            
            ctx.clip(); // Ù†Ù‚Øµ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ù†Ø¹Ù…Ù„ Ø¨Ø¯Ø§Ø®Ù„Ù‡Ø§ ÙÙ‚Ø·

            if (currentFilter === 'mosaic') {
                // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª
                const pixelSize = 15;
                ctx.imageSmoothingEnabled = false;
                
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ù…ØµØºØ±Ø© Ø«Ù… ØªÙƒØ¨ÙŠØ±Ù‡Ø§
                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„Ù‚Ø© Ù„Ù„ÙƒØ§Ù†ÙØ§Ø³
                const regionW = isCircle ? w : w;
                const regionH = isCircle ? w : h;
                const regionX = isCircle ? x - w/2 : x;
                const regionY = isCircle ? y - w/2 : y;

                const miniW = Math.max(1, regionW / pixelSize);
                const miniH = Math.max(1, regionH / pixelSize);

                ctx.drawImage(canvas, regionX, regionY, regionW, regionH, regionX, regionY, miniW, miniH);
                ctx.drawImage(canvas, regionX, regionY, miniW, miniH, regionX, regionY, regionW, regionH);
            
            } else if (currentFilter === 'blur') {
                // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶Ø¨Ø§Ø¨
                ctx.filter = 'blur(12px)';
                // Ù†Ø¹ÙŠØ¯ Ø±Ø³Ù… Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙˆÙ‚ Ù†ÙØ³Ù‡Ø§ (Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±)
                // ÙŠØ¬Ø¨ ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¶Ø¨Ø§Ø¨
                ctx.drawImage(canvas, 0, 0); 
                ctx.filter = 'none';

            } else if (currentFilter === 'color') {
                // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„ÙˆÙ† (Ø£Ø³ÙˆØ¯ Ù„Ù„Ø®ØµÙˆØµÙŠØ©)
                ctx.fillStyle = "#000000";
                ctx.fill(); // ÙŠÙ…Ù„Ø£ Ø§Ù„Ù…Ø³Ø§Ø± (Ø¯Ø§Ø¦Ø±Ø© Ø£Ùˆ Ù…Ø±Ø¨Ø¹)
                ctx.fillRect(x, y, w, h); // Ù„Ù„Ù…Ø±Ø¨Ø¹
            }

            ctx.restore();
        }

        // --- 3. Ø§Ù„Ø±Ø³Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ (Manual Brush) ---
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù„Ù…Ø³ Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function handleDraw(e) {
            if (!isDrawing) return;
            e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            const pos = getMousePos(e);
            const size = parseInt(brushSlider.value) * (canvas.width / 1000 * 2); // Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… Ù†Ø³Ø¨ÙŠØ§Ù‹
            
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ù„Ù„Ø±Ø³Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ
            applyEffectToRegion(pos.x, pos.y, size, size, true);
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„Ù„Ù…Ø³
        canvas.addEventListener('mousedown', (e) => { isDrawing = true; handleDraw(e); });
        canvas.addEventListener('mousemove', handleDraw);
        canvas.addEventListener('mouseup', () => { isDrawing = false; saveState(); });
        canvas.addEventListener('mouseleave', () => { isDrawing = false; });
        
        // Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Touch)
        canvas.addEventListener('touchstart', (e) => { isDrawing = true; handleDraw(e); });
        canvas.addEventListener('touchmove', handleDraw);
        canvas.addEventListener('touchend', () => { isDrawing = false; saveState(); });

        // --- 4. Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Auto Face) ---
        document.getElementById('btn-auto').addEventListener('click', async () => {
            if (!originalImage.src) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
            
            loader.style.display = 'flex';
            
            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ´Ù (Ù†Ø³ØªØ®Ø¯Ù… Tiny Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡)
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.3 });
                const detections = await faceapi.detectAllFaces(canvas, options);
                
                if (detections.length === 0) {
                    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¬ÙˆÙ‡ ÙˆØ§Ø¶Ø­Ø©.");
                }

                detections.forEach(det => {
                    const box = det.box;
                    // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø£Ø°Ù†ÙŠÙ† ÙˆØ§Ù„Ø´Ø¹Ø±
                    const padding = box.width * 0.15;
                    
                    applyEffectToRegion(
                        box.x - padding, 
                        box.y - padding, 
                        box.width + (padding*2), 
                        box.height + (padding*2),
                        false // Ù…Ø±Ø¨Ø¹
                    );
                });
                
                saveState();
            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª.");
            }
            
            loader.style.display = 'none';
        });

        // --- 5. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Undo / Save) ---
        function saveState() {
            if (historyStack.length > 8) historyStack.shift(); // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 8 Ø®Ø·ÙˆØ§Øª
            historyStack.push(canvas.toDataURL());
        }

        document.getElementById('btn-undo').addEventListener('click', () => {
            if (historyStack.length <= 1) return;
            historyStack.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const prevState = historyStack[historyStack.length - 1];
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = prevState;
        });

        document.getElementById('btn-save').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'mosaic_edit.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

    </script>
</body>
</html>
